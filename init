#!/bin/bash

echo '
 __      ___      _   _  _ ___ ___     ___ ___  ___ ___
 \ \    / / |    /_\ | \| | _ \_ _|__ / __/ _ \| _ \ __|
  \ \/\/ /| |__ / _ \| .  |  _/| |___| (_| (_) |   / _|
   \_/\_/ |____/_/ \_\_|\_|_| |___|   \___\___/|_|_\___|
'

echo '
    .___            .__       .__  __   
  __| _/_______  __ |__| ____ |__|/  |_ 
 / __ |/ __ \  \/ / |  |/    \|  \   __\
/ /_/ \  ___/\   /  |  |   |  \  ||  |  
\____ |\___  >\_/   |__|___|  /__||__|  
     \/    \/               \/         
'

echo '
wlanpi-core development environment setup & initial launcher
 
This script automates the setup process for developing with wlanpi_core:
 - Installs system dependencies (build tools, Python, networking utilities)
 - Creates a Python virtual environment in the current folder
 - Installs Python dependencies from requirements.txt and testing.txt
 - Configures firewall to allow development port 8000
 - Launches wlanpi_core in debug mode with auto-reload

Requires: Ubuntu/Debian system with sudo access
Usage: Intended for first run from the wlanpi-core root directory
'

if ! command -v sudo &> /dev/null; then
    echo "Error: sudo is not installed ... Please run as root or install sudo and try again ..."
    exit 1
fi

install_dependencies() {
    echo "Installing required depends ..."
    
    sudo apt-get update 

    if ! sudo apt-get install -y -q \
        build-essential \
        git \
        unzip \
        zip \
        nload \
        tree \
        ufw \
        nftables \
        vlan \
        sqlite3 \
        lldpd \
        xxd; then
        echo "Error: Failed to install build essentials and tools ..."
        exit 1
    fi

    if ! sudo apt-get install -y -q \
        dbus \
        pkg-config \
        gcc \
        libpq-dev \
        libdbus-glib-1-dev \
        libglib2.0-dev \
        cmake \
        libdbus-1-dev; then
        echo "Error: Failed to install development libraries ..."
        exit 1
    fi

    if ! sudo apt-get install -y -q \
        python3-pip \
        python3-dev \
        python3-venv \
        python3-wheel \
        python3-setuptools \
        python3-distutils \
        dh-python; then
        echo "Error: Failed to install Python packages ..."
        exit 1
    fi
}

if [ -d "venv" ]; then
    echo "Virtual environment 'venv' already exists ... Skipping creation ..."
else
    echo "Creating new virtual environment ..."
    if ! python3 -m venv venv; then
        echo "Error: Failed to create virtual environment ..."
        exit 1
    fi
fi

install_dependencies

# shellcheck disable=SC1091
source venv/bin/activate

if [ -f "requirements.txt" ]; then
    echo "Installing dependencies from requirements.txt ..."
    if ! pip install -r requirements.txt; then
        echo "Error: Failed to install Python requirements ..."
        exit 1
    fi
else
    echo "Warning: requirements.txt not found in current directory ..."
fi

if [ -f "testing.txt" ]; then
    echo "Installing dependencies from testing.txt ..."
    if ! pip install -r testing.txt; then
        echo "Error: Failed to install testing Python requirements ..."
        exit 1
    fi
else
    echo "Warning: testing.txt not found in current directory ..."
fi

echo "Configuring firewall to allow port 8000 ..."
if ! sudo ufw allow 8000; then
    echo "Error: Failed to configure firewall rule for port 8000 ..."
    exit 1
fi

echo 
echo "Starting wlanpi_core in debug mode ..."
echo "Protip: next time use ./run to skip the setup ..."
echo "Executing: sudo venv/bin/python -m wlanpi_core --reload --debug"
echo
if ! sudo venv/bin/python -m wlanpi_core --reload --debug; then
    echo "Error: Failed to start wlanpi_core ..."
    exit 1
fi
