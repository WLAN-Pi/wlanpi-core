#!/bin/bash
# postrm script
#
# see: dh_installdeb(1)
# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

function unlink_if_existing() {
    if [ -L "$1" ]; then
        unlink "$1"
    fi
}

if [ "$1" = "remove" ] || [ "$1" = "purge" ]; then
    iptables -D wlanpi_core -p tcp --dport 31415 -j ACCEPT 2>/dev/null || true
    iptables -D wlanpi_core -p udp --dport 31415 -j ACCEPT 2>/dev/null || true
    iptables -D INPUT -j wlanpi_core 2>/dev/null || true
    iptables -F wlanpi_core 2>/dev/null || true 
    iptables -X wlanpi_core 2>/dev/null || true

    rm -rf /etc/wlanpi-core/.secrets

    if [ -d /var/log/wlanpi_core/debug ] && [ -z "$(ls -A /var/log/wlanpi_core/debug)" ]; then
        rmdir /var/log/wlanpi_core/debug || true
    fi

    if [ -d /var/log/wlanpi_core ] && [ -z "$(ls -A /var/log/wlanpi_core)" ]; then
        rmdir /var/log/wlanpi_core || true
    fi

    unlink_if_existing /etc/nginx/nginx.conf
    unlink_if_existing /opt/wlanpi-core/workingdirectory
    unlink_if_existing /etc/nginx/sites-enabled/wlanpi_core.conf

    if iptables -C ufw-user-input -p tcp --dport 31415 -j ACCEPT 2>/dev/null; then
        iptables -D ufw-user-input -p tcp --dport 31415 -j ACCEPT
        echo "[Network] TCP port 31415: Firewall rule removed."
    fi

    if iptables -C ufw-user-input -p udp --dport 31415 -j ACCEPT 2>/dev/null; then
        iptables -D ufw-user-input -p udp --dport 31415 -j ACCEPT
        echo "[Network] UDP port 31415: Firewall rule removed."
    fi
fi

exit 0
